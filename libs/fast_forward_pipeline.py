import itertools
import pickle
import re
from collections import Counter

from libs.data_collectors.raws_collector import grams


def find_grouped_info(query, scache=None, gcache=None, fgroups=None):
    if scache is None:
        with open("info/search_cache", "rb") as f:
            scache = pickle.load(f)
    if gcache is None:
        with open("info/goods_cache", "rb") as f:
            gcache = pickle.load(f)
    relevant_cats = choose_cats(query, scache=scache, fgroups=fgroups, gcache=gcache)
    answer = [gcache[cat] for cat in relevant_cats]
    return answer


def choose_cats(query, scache=None, fgroups=None, gcache=None, min_n=10):
    if not query:
        return list()
    if scache is None:
        with open("info/search_cache", "rb") as f:
            scache = pickle.load(f)
    if fgroups and (gcache is None):
        with open("info/goods_cache", "rb") as f:
            gcache = pickle.load(f)
    query_grams = grams(query)
    c = Counter()
    if fgroups:
        rel_gr = {15} | set(int(x) for x in fgroups.split())
    for gram in query_grams:
        gcats = scache.get(gram, False)
        if gcats:
            if fgroups:
                gcats = [x for x in gcats if gcache.get(x, {}).get('fg_id', None) in rel_gr]
            c.update(gcats)
    rel_cats = list()
    min_val = len(query_grams)
    for cat, val in c.most_common():
        if (len(rel_cats) >= min_n) and (val < min_val):
            break
        rel_cats.append(cat)
        min_val = val
    return rel_cats


{
    ('ayunova', 4),
    ('abena', 5),
    ('абена', 5),
    ('afinion', 10),
    ('афинион', 10),
    ('alcosafe', 11),
    ('алкосейф', 11),
    ('alcolock', 12),
    ('алколок', 12),
    ('alkmene', 13),
    ('allrest', 14),
    ('allevyn', 15),
    ('amnisure', 16),
    ('амнишур', 16),
    ('amnioquick', 17),
    ('artemis', 18),
    ('артемис', 18),
    ('arthrex', 19),
    ('артрекс', 19),
    ('ascensia', 20),
    ('асцензия', 20),
    ('entrust', 20),
    ('энтраст', 20),
    ('asiakiss', 21),
    ('азиякисс', 21),
    ('atrauman', 22),
    ('balsamed', 26),
    ('бальзамед', 26),
    ('bambo', 27),
    ('bambo', 27),
    ('berimed', 32),
    ('беримед', 32),
    ('beurer', 34),
    ('biosecure', 35),
    ('biokosma', 36),
    ('bionime', 37),
    ('бионайм', 37),
    ('бионим', 37),
    ('бионова', 38),
    ('bionova', 38),
    ('bioturm', 39),
    ('bluecare', 40),
    ('bombbar', 41),
    ('bombar', 41),
    ('бомбар', 41),
    ('бомббар', 41),
    ('bonadea', 42),
    ('bootybar', 43),
    ('бутибар', 43),
    ('bucatini', 44), 
    ('букатини', 44),    
    ('carelink', 47),
    ('caresens', 48),
    ('cavilon', 49),
    ('кавилон', 49),
    ('chikalab', 50),
    ('чикалаб', 50),
    ('citizen', 51),
    ('ситизен', 51),
    ('cobas', 55),
    ('combur', 56),
    ('кобас', 55),
    ('комбур', 56),
    ('convacare', 58),
    ('convatec', 59),
    ('cosmoetica', 60),
    ('cosnature', 61),
    ('curaprox', 62),
    ('курапрокс', 62),
    ('кутасепт', 63),
    ('cutasept', 63),
    ('dana', 64),
    ('дана', 64),
    ('dettol', 65),
    ('dexcom', 66),
    ('декском', 66),
    ('diacont', 71),
    ('диаконт', 71),
    ('dingo', 72),
    ('динго', 72),
    ('dirui', 73),
    ('dison', 74),
    ('дисон', 74),
    ('foot', 77),
    ('фут', 77),
    ('scheller', 78),
    ('шеллер', 78),
    ('stern', 79),
    ('wild', 80),
    ('drager', 81),
    ('droplet', 82),
    ('штерн', 79),
    ('вайлд', 80),
    ('драгер', 81),
    ('дроплет', 82),
    ('duracell', 84),
    ('duracel', 84),
    ('дюраселл', 84),
    ('дюрасел', 84),
    ('eglydium', 89),
    ('elskin', 91),
    ('energizer', 92),
    ('enlite', 93),
    ('erba', 94),
    ('evitest', 95),
    ('evo', 96),
    ('элскин', 91),
    ('энерджайзер', 92),
    ('энлайт', 93),
    ('эрба', 94),
    ('эвитест', 95),
    ('ево', 96),
    ('эво', 96),
    ('fanline', 98),
    ('фанлайн', 98),
    ('fitelle', 103),
    ('flexitol', 104),
    ('fluo', 105),
    ('footness', 106),
    ('footprim', 107),
    ("forster", 108),
    ('frautest', 109),
    ('freestyle', 110),
    ('freepack', 111),
    ('freeze', 112),
    ('frio', 113),
    ('gp', 114),
    ('флуо', 105),
    ('футнесс', 106),
    ('фитприм', 107),
    ("форстер", 108),
    ('фраутест', 109),
    ('фристайл', 110),
    ('фрипак', 111),
    ('фриз', 112),
    ('акшщ', 113),
    ('джипи', 114),
    ('gothaplast', 118),
    ('grassolind', 119),
    ('гразолинд', 119),
    ('грасолинд', 119),
    ('guardian', 121),
    ('гардиан', 121),
    ('heel', 124),
    ('higlo', 125),
    ('histoacryl', 126),
    ('hotex', 127),
    ('hydroclean', 129),
    ('hydrocoll', 130),
    ('hydrosorb', 131),
    ('hydrotul', 132),
    ('hypofree', 133),
    ('гидроклин', 129),
    ('гидроколл', 130),
    ('гидрокол', 130),
    ('hydrosorb', 131),
    ('гидросорб', 131),
    ('hydrotul', 132),
    ('гидротюль', 132),
    ('hypofree', 133),
    ('гипофри', 133),
    ('хипофри', 133),
    ('inadine', 138),
    ('insula', 139),
    ('insulain', 140),
    ('insupen', 141),
    ('инсупен', 141),
    ('инсупэн', 141),
    ('khadi', 143),
    ('labstrip', 145),
    ('lanzo', 147),
    ('ланзо', 147),
    ('ланцо', 147),
    ('librederm', 148),
    ('либредерм', 148),
    ('lipidocare', 149),
    ('липидокер', 149),
    ('липидокеар', 149),
    ('martina', 150),
    ('gebhardt', 150),
    ('мартина', 150),
    ('maxell', 151),
    ('макселл', 151),
    ('medisense', 152),
    ('medisafe', 153),
    ('medlance', 154),
    ('медланс', 154),
    ('medtronic', 155),
    ('медтроник', 155),
    ('mepilex', 156),
    ('micral', 157),
    ('microlet', 159),
    ('milford', 160),
    ('minilink', 161),
    ('molicare', 162),
    ('molimed', 163),
    ('momert', 164),
    ('микролет', 159),
    ('милфорд', 160),
    ('минилинк', 161),
    ('моликар', 162),
    ('моликеар', 162),
    ('молимед', 163),
    ('момерт', 164),
    ('multistix', 168),
    ('мультистикс', 168),
    ('kamchatka', 172),
    ('камчатка', 172),
    ('naturalis', 173),
    ('navigator', 174),
    ('niltac', 175),
    ('novasweet', 176),
    ('novosweet', 176),
    ('натуралис', 173),
    ('навигатор', 174),
    ('нилтак', 175),
    ('новасвит', 176),
    ('novopen', 178),
    ('novosvit', 179),
    ('numismed', 180),
    ('nycocard', 181),
    ('omnifix', 182),
    ('omnican', 183),
    ('omnipod', 184),
    ('omron', 185),
    ('новопен', 178),
    ('новопэн', 178),
    ('новосвит', 179),
    ('никокард', 181),
    ('омнификс', 182),
    ('омникан', 183),
    ('омнипод', 184),
    ('омрон', 185),
    ('oraquick', 190),
    ('orto', 191),
    ('ораквик', 190),
    ('орто', 191),
    ('ovuplan', 193),
    ('panasonic', 194),
    ('paradigm', 195),
    ('patency', 196),
    ('pekana', 197),
    ('pendiq', 198),
    ('овуплан', 193),
    ('panasonik', 194),
    ('панасоник', 194),
    ('парадигм', 195),
    ('paradygm', 195),
    ('patency', 196),
    ('патенси', 196),
    ('пекана', 197),
    ('пендик', 198),
    ('пендику', 198),
    ('pendik', 198),
    ('permafoam', 200),
    ('пермафоам', 200),
    ('пермафом', 200),
    ('pillcam', 202),
    ('planeta', 203),
    ('plastipack', 204),
    ('powerup', 205),
    ('пилкам', 202),
    ('планета', 203),
    ('пластипак', 204),
    ('поверап', 205),
    ('president', 207),
    ('primavera', 208),
    ('президент', 207),
    ('примавера', 208),

}

regs_manuf = (
    (r'\b[aa][nн ][dд]\b', 2),
    (r'[aа]1[cс](?:now|н[ао]у)', 3),
    (r'[aа][сcqкk]{1,3}[uуy] ?(?:[cс]he[cс]k|чек)', 6),
    (r'[aа][сcqкk]{1,3}[uуy] ?(?:trend?|тр[еэ]нд?)', 7),
    (r'[aа][cскk](?:ti|ти) ?(?:fine|файн)', 8),
    (r'[aа][cскk](?:ti|ти) ?(?:lance|лансе?)', 9),
    (r'(?:a[uv]to ?ject|а[ву]то ?дж[еэ]кт)', 23),
    (r'(?:a[uv]to ?pen|а[ву]то ?п[еэ]н)', 24),
    (r'[bбв] ?(?:well?|в[эе]лл?)', 25),
    (r'(?:be ?sure|би ?шуре?)', 28),
    (r'(?:be ?fit|би ?фит)', 29),
    (r'beauty ?care', 30),
    (r'beauty ?style', 31),
    (r'(?:beta ?chec?k|б[эе]та ?чек)', 33),
    (r'(?:cs|[кц]с) ?(?:medica|медика)', 45),
    (r'(?:cardio ?chec?k|кардио ?чек)', 46),
    (r'(?:clever ?chec?k|кл[эе]в[эе]р ?чек)', 53),
    (r'(?:[ck]oag[uy] ?check|ко[ау]гу ?чек)', 54),
    (r'(?:conto?ur|конто?ур)', 57),
    (r'(?:dextro|д[эе]кстро) ?4', 67),
    (r'(?:dez ?pen|д[еэ]з ?п[еэ]н)', 68),
    (r'(?:dia ?line|диа ?лайн)', 69),
    (r'(dia ?ultra ?derm|диа ?ультра ?д[эе]рм)', 70),
    (r'(?:dopp?el ?herz|допп?ель ?[гх]ерц)', 75),
    (r'(?:dia[sz]|диа[сз])\b', 76),
    (r'duo ?care', 83),
    (r'(?:em ?fix|ем ? фикс)', 85),
    (r'(?:easy ?release?|изи ?р[еи]лиз?)', 86),
    (r'(?:easy ?set|изи ?с[еэ]т)', 87),
    (r'(?:easy ?t[oa]u?ch|изи ?тач)', 88),
    (r'(?:element ?multi|элемент ?мульти)', 90),
    (r'(?:excess ?free|эксц?есс? ?фри)', 97),
    (r'(?:fast ?set|фаст ?с[еэ]т)', 99),
    (r'(?:fee?l ?fine|фил ?файн)', 100),
    (r'(?:fit(?: ?a?nd? ?)?sweet|фит ?[эа]?нд? ?свит)', 101),
    (r'(?:fit ?active?|фит ?актив)', 102),
    (r'(?:global ?white|глобал ?[ув]айт)', 115),
    (r'(?:glu[ck]o[wv]i[sz]e|глюковай[зс])', 116),
    (r'(?:g ?mate|(?:г|джи) ?м[эе]йт)', 117),
    (r'(?:green ?nature|грин ?н[аэе]йч[аеэ]р?)', 120),
    (r'(?:happ?y ?monkey|х[эе]пп?и ?м[ао]нки)', 122),
    (r'(?:hartmann?|хартманн?)', 123),
    (r'(?:huma ?pen|х[ую]ма ?п[эе]н)', 128),
    (r'(?:ай|[иi]) ?(?:port|порт)', 134),
    (r'(?:ай|[иi]) ?(?:stat|стат)', 135),
    (r'(?:ime ?dc|(?:ай|и)ми? ?ди?[сц]и?)', 136),
    (r'(?:ice ?box|айс ?бокс)', 137),
    (r'(?:invitro ?test|инвитро ?т[эе]ст)', 142),
    (r'(?:know ?now|ноу ?нау)', 144),
    (r'(?:lady ?test|л[еэ]ди ?т[эе]ст)', 146),
    (r'(?:mi[ck]ro ?fine|микро ?файн)', 158),
    (r'(?:multi ?lancet|мульти ?ланцет)', 165),
    (r'(?:multicare(?: ?in)?|мультик[еэ]?ар?(?: ?ин))', 166),
    (r'(?:multi ?chec?k|мульти ?чек)', 167),
    (r'(?:nano ?chec?ker|нано ?чекер)', 169),
    (r'(?:nar[ck]ochec?k|нарко ?чек)', 170),
    (r'(?:nar[ck]oscreen|нарко ?скрин)', 171),
    (r'(?:nov[oa] ?fine|нов[оа] ?файн)', 177),
    (r'\b(?:on ?call|он ?колл?)\b', 186),
    (r'(?:one ?tou?ch|[ув]ан ?т[ао]у?ч)', 187),
    (r'(?:opti ?clic?k|опти ?клик)', 188),
    (r'(?:optium ?omega|оптиум ?омега)', 189),
    (r'(?:ott?oboc?k|отт?обок)', 192),
    (r'(?:peno ?fine|пено ?файн)', 199),
    (r'(?:(?:ph|f)ill?ips|филл?ипс)', 201),
    (r'(?:premium ?diag(?:nosti[ck]s?)|премиум ?диаг(?:ностикс?))', 206),
    (r'(?:protein ?rex|протеин ?р[еэ]кс)', 209),
    (r'(?:q ?lance?|кь?[ую] ?лан[сц][еэ]?)', 210),
    ('quick-serter', 211),
    ('racionika', 212),
    ('ratioline', 213),
    ('realcaps', 214),
    ('redox', 215),
    ('repeptide', 216),
    ('resource', 217),
    ('ricola', 218),
    ('ritmix', 219),
    ('rose bengal', 220),
    ('sd check gold', 221),
    ('sfm', 222),
    ('so bio etic', 223),
    ('salton', 224),
    ('salus-haus', 225),
    ('sanatur', 226),
    ('sanitelle', 227),
    ('schoenenberger', 228),
    ('scholl', 229),
    ('selfy check', 230),
    ('sen serter', 231),
    ('sensocard', 232),
    ('silesse', 233),
    ('silhouette', 234),
    ('skinfood', 235),
    ('skinlite', 236),
    ('slamix', 237),
    ('smartbuy', 238),
    ('smith & nephew', 239),
    ('soeks', 240),
    ('solar', 241),
    ('solgar', 242),
    ('sosu', 243),
    ('speick', 244),
    ('splat', 245),
    ('sterilux', 246),
    ('superline', 247),
    ('suprasorb', 248),
    ('sure-t', 249),
    ('surecan', 250),
    ('td thin', 251),
    ('tear', 252),
    ('tenderwet', 253),
    ('tigon', 254),
    ('total cholesterol', 255),
    ('trop t', 256),
    ('true result', 257),
    ('ultratech', 258),
    ('unifine', 259),
    ('unistrip', 260),
    ('varta', 261),
    ('verifine', 262),
    ('vilenta', 263),
    ('vitrex', 264),
    ('weleda', 265),
    ('wozulim', 266),
    ('yegi', 267),
    ('yumearth', 268),
    ('zero', 269),
    ('ebsensor', 270),
    ('icheck', 271),
    ('ipro2', 272),
    ('iscreen', 273),
    ('qlabs', 274),
    ('амит', 275),
    ('амнп', 276),
    ('амт', 277),
    ('адаптер', 278),
    ('аквапилинг', 279),
    ('алгель', 280),
    ('алко-скрин', 281),
    ('алкозамок', 282),
    ('алкосенсор', 283),
    ('алкоскан', 284),
    ('алмаг', 285),
    ('алфавит', 286),
    ('альхон', 287),
    ('амникатор', 288),
    ('анализатор', 289),
    ('ангиоскан', 290),
    ('арнебия', 291),
    ('асепта', 292),
    ('атмос', 293),
    ('баланс калорий', 294),
    ('бандаж', 295),
    ('белобаза', 296),
    ('биоматик', 297),
    ('биосенсор', 298),
    ('биоскан', 299),
    ('будьте уверены', 300),
    ('вено плюс', 301),
    ('виллафита', 302),
    ('виталфарм', 303),
    ('витамир', 304),
    ('витамишки', 305),
    ('витафон', 306),
    ('витацентр', 307),
    ('гипохит', 308),
    ('гликогемотест', 309),
    ('глюкокард', 310),
    ('губка боб', 311),
    ('дарсонваль', 312),
    ('дезиконт', 313),
    ('диадент', 314),
    ('диадерм', 315),
    ('диаглюк', 316),
    ('диановости', 317),
    ('дыши', 318),
    ('дюна', 319),
    ('ессентуки', 320),
    ('живые фрукты', 321),
    ('жить здорово', 322),
    ('здоровый перекус', 323),
    ('иха', 324),
    ('ива', 325),
    ('иммунтех', 326),
    ('иммунохром', 327),
    ('капитан сильвер', 328),
    ('кетоглюк', 329),
    ('кольпо', 330),
    ('компас здоровья', 331),
    ('компливит', 332),
    ('крейт', 333),
    ('кусалочка', 334),
    ('ламзак', 335),
    ('ланцет', 336),
    ('лошадиная сила', 337),
    ('ляпко', 338),
    ('магофон', 339),
    ('макмастер', 340),
    ('медисана', 341),
    ('медолад', 342),
    ('мелестра', 343),
    ('месолт', 344),
    ('микротон', 345),
    ('мультилор', 346),
    ('направит', 347),
    ('наркостоп', 348),
    ('нести данте', 349),
    ('окситест', 350),
    ("ол'лайт", 351),
    ('олиджим', 352),
    ('омелон', 353),
    ('офтолик', 354),
    ('пп', 355),
    ('петродиет', 356),
    ('повидон', 357),
    ('рэд', 358),
    ('рефлеком', 359),
    ('ринсапен', 360),
    ('ролепласт', 361),
    ('росинсулин', 362),
    ('сelsite', 363),
    ('соэкс', 364),
    ('самоздрав', 365),
    ('сателлит', 366),
    ('светозар', 367),
    ('серебрин', 368),
    ('симбиолакт', 369),
    ('сластея', 370),
    ('сорбалгон', 371),
    ('спарк', 372),
    ('стимэл', 373),
    ('стрептатест', 374),
    ('тегадерм', 375),
    ('тест', 376),
    ('тривес', 377),
    ('тутти', 378),
    ('умные сладости', 379),
    ('ури ph', 380),
    ('урибел', 381),
    ('уриглюк', 382),
    ('урикет', 383),
    ('уриполиан', 384),
    ('уриреал', 385),
    ('урискан', 386),
    ('ути-booty', 387),
    ('фармагидрация', 388),
    ('фельдшер', 389),
    ('фея', 390),
    ('фит парад', 391),
    ('фитодиабетол', 392),
    ('фитомикс', 393),
    ('флаксы', 394),
    ('фрутилад', 395),
    ('фэст', 396),
    ('хрустила', 397),
    ('целевит', 398),
    ('шелковица', 399),
    ('эвалар', 400),
    ('эго', 401),
    ('экофлор', 402),
    ('элфор', 403),
)


